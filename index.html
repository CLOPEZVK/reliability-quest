<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliability Quest: Replayability Edition</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --parchment: #d4c5a4;
            --parchment-dark: #a89f81;
            --text-ink: #2b1d0e;
            --accent-gold: #ffcc00;
            --magic-cyan: #00ffcc;
            --blood-red: #8a0303;
            --success-green: #2e8b57;
            --font-header: 'Georgia', serif;
            --font-body: 'Courier New', monospace;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-ink);
            font-family: var(--font-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        /* RETRO CRT EFFECT OVERLAY */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: var(--parchment);
            border: 8px double #4a3c2a;
            box-shadow: 0 0 50px rgba(0,255,204, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* DICE OVERLAY */
        #dice-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--parchment);
        }

        .d20-container {
            position: relative;
            width: 150px;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* CSS Hexagon D20 Shape */
        .d20-die {
            width: 120px;
            height: 138px; 
            background-color: var(--text-ink);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            font-weight: bold;
            color: white;
            font-family: var(--font-header);
            transition: transform 0.1s;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid rgba(255,255,255,0.2);
        }

        /* Animations */
        .shake { animation: shake-anim 0.5s infinite; }
        @keyframes shake-anim {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .roll-result-success { background-color: var(--success-green); box-shadow: 0 0 30px var(--success-green); }
        .roll-result-fail { background-color: #555; box-shadow: 0 0 30px #555; }
        .roll-result-critfail { background-color: var(--blood-red); box-shadow: 0 0 40px var(--blood-red); }
        .roll-result-crit { background-color: var(--accent-gold); color: black; box-shadow: 0 0 50px var(--accent-gold); animation: pulse 0.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }


        /* HEADER */
        header {
            background: #2b1d0e;
            color: var(--parchment);
            padding: 1rem;
            text-align: center;
            border-bottom: 4px solid #856f48;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        h1 { margin: 0; font-family: var(--font-header); text-transform: uppercase; letter-spacing: 3px; color: var(--accent-gold); text-shadow: 2px 2px 0px #000; }

        /* SCREENS */
        .screen { padding: 2rem; flex: 1; display: none; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }

        /* CLASS SELECTION */
        .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; padding: 1rem; }
        .class-card { background: #e6dabb; border: 2px solid #6e5a3e; padding: 10px; border-radius: 4px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center; position: relative; }
        .class-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: var(--text-ink); }
        .card-image-slot { width: 100%; height: 150px; background: #444; margin-bottom: 10px; border: 2px solid #2b1d0e; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-image-slot img { width: 100%; height: 100%; object-fit: cover; }
        .card-image-slot.missing-img img { display: none; }
        .card-image-slot.missing-img::after { content: '‚öîÔ∏è'; font-size: 3rem; }
        .class-name { font-family: var(--font-header); font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #6e5a3e; margin-bottom: 5px; padding-bottom: 5px; }
        .class-role { color: #666; font-size: 0.8rem; font-style: italic; }

        /* MAP UI */
        .map-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; padding: 1rem; margin-top: 1rem; align-content: center; height: 100%; }
        .map-zone { background: #2b1d0e; border: 4px outset #6e5a3e; color: var(--parchment); text-align: center; cursor: pointer; font-family: var(--font-header); position: relative; transition: 0.2s; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; min-height: 200px; background-size: cover; background-position: center; overflow: hidden; text-shadow: 2px 2px 4px #000; }
        .map-zone-content { background: linear-gradient(transparent, rgba(0,0,0,0.9)); width: 100%; padding: 1rem; padding-top: 3rem; }
        .map-zone:hover { transform: scale(1.03); border-color: var(--accent-gold); }
        .map-zone h3 { margin: 0; color: var(--accent-gold); text-transform: uppercase; font-size: 1.4rem; }
        .map-zone .icon { font-size: 3rem; margin-bottom: 10px; display: none; } 
        .map-zone.missing-zone-img { background: #4a3c2a; justify-content: center; }
        .map-zone.missing-zone-img .icon { display: block; }
        .map-zone.missing-zone-img .map-zone-content { background: none; padding: 1rem; padding-top: 0; }
        .map-zone.completed { filter: grayscale(1); opacity: 0.6; border-style: inset; cursor: default; pointer-events: none; }
        .map-zone.completed::after { content: "CLEARED"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); border: 3px solid var(--magic-cyan); color: var(--magic-cyan); padding: 0.5rem; font-weight: bold; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.8); z-index: 10; }

        /* GAMEPLAY UI & INVENTORY */
        .hud-bar { display: flex; justify-content: space-between; background: #2b1d0e; color: var(--parchment); padding: 0.5rem 1rem; font-family: var(--font-body); border-bottom: 2px solid #856f48; flex-wrap: wrap; }
        .health-bar-container { width: 100px; height: 15px; background: #440000; border: 1px solid #fff; margin-left: 5px; display: inline-block; vertical-align: middle; }
        .health-fill { height: 100%; background: #ff0000; width: 100%; transition: width 0.5s; }
        .inventory-box { display: inline-flex; gap: 5px; vertical-align: middle; margin-left: 5px; }
        .inv-item { font-size: 1.2rem; cursor: help; filter: drop-shadow(0 0 2px gold); }
        .journal-entry { background: rgba(255,255,255,0.4); padding: 1rem; margin-bottom: 1rem; border-left: 4px solid var(--text-ink); font-size: 1.1rem; line-height: 1.5; }
        .reflection-box { background: #2b1d0e; color: var(--accent-gold); padding: 1rem; margin-top: 1rem; border: 2px dashed var(--accent-gold); font-size: 0.9rem; display: none; }
        .btn-retro { background: #2b1d0e; color: var(--parchment); border: 2px outset #6e5a3e; padding: 1rem; font-family: var(--font-body); font-size: 1rem; cursor: pointer; text-align: left; margin-bottom: 0.5rem; transition: 0.1s; position: relative; }
        .btn-retro:hover:not(:disabled) { background: #4a3c2a; color: var(--magic-cyan); border-style: inset; padding-left: 1.5rem; }
        .btn-retro:active:not(:disabled) { border-style: inset; transform: translateY(2px); }
        .btn-retro:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); border-color: #444; color: #888; }
        .sfx-toggle { position: absolute; top: 15px; right: 15px; background: none; border: 1px solid var(--accent-gold); color: var(--accent-gold); cursor: pointer; font-size: 0.8rem; padding: 5px; }

        @media (max-width: 600px) {
            .game-container { height: 100vh; border: none; }
            .class-grid, .map-container { grid-template-columns: 1fr; }
            .hud-bar { font-size: 0.8rem; flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <header>
        <h1>Reliability Quest</h1>
        <div style="font-size: 0.8rem; opacity: 0.8;">The Legend of Uptime</div>
        <button class="sfx-toggle" id="sfx-btn" onclick="toggleAudio()">üîä SFX: ON</button>
    </header>

    <!-- DICE OVERLAY -->
    <div id="dice-overlay">
        <div class="d20-container">
            <div id="d20-die" class="d20-die">20</div>
        </div>
        <h2 id="roll-text" style="margin-top: 20px; text-transform: uppercase; letter-spacing: 2px;">Rolling...</h2>
    </div>

    <!-- 1. CLASS SELECTION -->
    <div id="start-screen" class="screen active">
        <div style="text-align: center; margin-bottom: 1rem;">
            <h2>Select Your Avatar</h2>
            <p>The factory floors of Assetia grow cold. Who will light the fires?</p>
        </div>
        <div class="class-grid" id="class-list"></div>
    </div>

    <!-- 2. MAP SCREEN -->
    <div id="map-screen" class="screen">
        <div style="text-align: center;">
            <h2>Map of Assetia</h2>
            <p>Clear all sectors to unlock the Final Stand.</p>
        </div>
        <div class="map-container" id="map-grid">
            <!-- Zones Injected Here -->
        </div>
    </div>

    <!-- 3. GAMEPLAY SCREEN -->
    <div id="game-screen" class="screen">
        <div class="hud-bar">
            <div><span id="hero-name">Hero</span></div>
            <div>HP: <div class="health-bar-container"><div class="health-fill" id="hp-bar"></div></div></div>
            <div>XP: <span id="xp-display" style="color:var(--magic-cyan)">0</span></div>
            <div>üéí: <span id="inventory-display" class="inventory-box">Empty</span></div>
        </div>

        <div id="story-area" style="flex:1; overflow-y: auto; padding: 1rem;"></div>
        <div id="controls-area" style="padding: 1rem; background: rgba(0,0,0,0.05); border-top: 2px solid #6e5a3e;"></div>
    </div>

    <!-- 4. END SCREEN -->
    <div id="end-screen" class="screen" style="text-align: center; justify-content: center;">
        <h2 id="end-title" style="font-size: 2rem; margin-bottom: 1rem;">Quest Complete</h2>
        <p id="end-desc" style="font-size: 1.2rem;">The assets are safe.</p>
        <br>
        <div style="background: #fff; padding: 1rem; border: 1px solid #000; display: inline-block; margin: 0 auto;">
            Final Reliability Score: <strong id="final-score">0</strong>
        </div>
        <br><br>
        <button class="btn-retro" style="text-align: center;" onclick="location.reload()">New Game</button>
    </div>
</div>

<script>
    /* --- SOUND ENGINE --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioEnabled = true;

    function toggleAudio() {
        audioEnabled = !audioEnabled;
        document.getElementById('sfx-btn').innerText = audioEnabled ? "üîä SFX: ON" : "üîá SFX: OFF";
    }

    function playSound(type) {
        if (!audioEnabled) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'hover') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.05, now); osc.start(now); osc.stop(now + 0.05);
        } else if (type === 'click') {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(40, now + 0.1); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'success') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.setValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'fail') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.2, now); osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'loot') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.2); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'rolling') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(50, now); osc.frequency.linearRampToValueAtTime(20, now + 1.0); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 1.0);
        }
    }

    /* --- CONFIG --- */
    const CLASSES = [
        { id: 'knight', name: 'Condition Knight', role: 'CBM Specialist', img: 'img/knight.png', bonus: 'detect' },
        { id: 'sage', name: 'Data Sage', role: 'Analyst', img: 'img/sage.png', bonus: 'analyze' },
        { id: 'cleric', name: 'Planner Cleric', role: 'Planner', img: 'img/cleric.png', bonus: 'plan' },
        { id: 'wrench', name: 'Wrenchblade', role: 'Technician', img: 'img/wrench.png', bonus: 'repair' },
        { id: 'wizard', name: 'Reliability Wizard', role: 'Engineer', img: 'img/wizard.png', bonus: 'strategy' }
    ];

    const ZONES = [
        { id: 'plant', name: 'The Eastern Plant', icon: 'üè≠', img: 'img/plant.png' },
        { id: 'cmms', name: 'CMMS Tower', icon: 'üè∞', img: 'img/cmms.png' },
        { id: 'dungeon', name: 'Dungeon of Inventory', icon: 'üì¶', img: 'img/dungeon.png' }
    ];

    const TOOLS = {
        irScanner: { name: "IR Scanner", icon: "üî¶" },
        spareSeal: { name: "Spare Seal", icon: "‚≠ï" },
        rcaScroll: { name: "Scroll of RCA", icon: "üìú" },
        vibSword: { name: "Vibro Sword", icon: "‚öîÔ∏è" },
        backupDisk: { name: "Backup Disk", icon: "üíæ" },
        manual: { name: "OEM Manual", icon: "üìò" }
    };

    /* --- SCENARIO DATABASE --- */
    // EXPANDED POOL FOR REPLAYABILITY
    const SCENARIO_DB = [
        // ZONE: PLANT (5 Scenarios)
        {
            zone: 'plant',
            title: "The Hum of Hazard",
            text: "You patrol the Eastern Plant. The air smells of oil. Suddenly‚Äîbzzzzzzmmmmmmmmm‚Äîa low hum echoes from the great Cooling Fan of Chiller 13.",
            reflection: "PRO TIP: Early detection is key.",
            choices: [
                { text: "Draw Vibration Sword (Scan Bearings)", type: "detect", result: "success", msg: "Your gauntlet trembles. Unbalanced shaft! You catch it early. You find a dropped scanner nearby. (+20 XP)", xp: 20, damage: 0, reward: "vibSword" },
                { text: "Summon Thermal Spirit (IR Scan)", type: "detect", result: "neutral", msg: "Your vision reveals a hot spot. You found an IR Scanner! (+10 XP)", xp: 10, damage: 0, reward: "irScanner" },
                { text: "Consult the Scribes (Ask Technician)", type: "analyze", result: "fail", msg: "He shrugs. Not helpful. The hum gets louder.", xp: 2, damage: 10 },
                { text: "Do Nothing", type: "lazy", result: "crit_fail", msg: "The fan explodes. Catastrophic failure.", xp: 0, damage: 40 }
            ]
        },
        {
            zone: 'plant',
            title: "The Gremlin of Grease",
            text: "A technician reports overheating motors. The gremlin of over-lubrication may be near.",
            reflection: "REMEMBER: More grease isn't always better.",
            choices: [
                { text: "Use IR Scanner (Check Temps)", type: "detect", result: "success", msg: "With your scanner, you confirm the high temps and drain the excess grease. Perfect fix! (+25 XP)", xp: 25, damage: 0, requires: "irScanner" },
                { text: "Add More Grease", type: "lazy", result: "crit_fail", msg: "POP! The bearing seal bursts. You made it worse. (0 XP)", xp: 0, damage: 30 },
                { text: "Monitor by Hand", type: "analyze", result: "neutral", msg: "It feels hot, but you aren't sure how hot. Risky. (+10 XP)", xp: 10, damage: 5 }
            ]
        },
        {
            zone: 'plant',
            title: "The Alignment Crypt",
            text: "A grinding noise haunts the central pump. The previous maintenance log shows vague entries.",
            reflection: "TIP: Laser alignment saves bearings.",
            choices: [
                { text: "Use Laser Alignment Spell", type: "repair", result: "success", msg: "Perfect alignment. The noise fades. (+25 XP)", xp: 25, damage: 0 },
                { text: "Align by Eye", type: "repair", result: "fail", msg: "It runs... for now. A gremlin chuckles in the shadows. (+5 XP)", xp: 5, damage: 10 },
                { text: "Log Work & Delay", type: "plan", result: "neutral", msg: "You've kicked the can. The problem still lurks. (+10 XP)", xp: 10, damage: 5 }
            ]
        },
        {
            zone: 'plant',
            title: "The Enigma of Energy Efficiency",
            text: "Power consumption spikes during night shifts. The Enigma of Energy Waste puzzles the facility.",
            reflection: "INSIGHT: Idle equipment consumes power.",
            choices: [
                { text: "Deploy Energy Monitoring Runes", type: "detect", result: "success", msg: "You discover idle equipment left running. (+23 XP)", xp: 23, damage: 0 },
                { text: "Replace All Motors", type: "repair", result: "neutral", msg: "Expensive, but helps partially. (+14 XP)", xp: 14, damage: 7 },
                { text: "Blame the Utility Company", type: "lazy", result: "fail", msg: "The bills keep rising. (+2 XP)", xp: 2, damage: 15 }
            ]
        },
        {
            zone: 'plant',
            title: "The Shuddering Compressor",
            text: "The main air compressor is shaking violently. Production will halt if it trips.",
            reflection: "DIAGNOSTICS: Vibration analysis can distinguish between looseness, imbalance, and surge.",
            choices: [
                { text: "Analyze Vibration Signature", type: "detect", result: "success", msg: "It's compressor surge! You adjust the inlet vanes just in time. (+25 XP)", xp: 25, damage: 0 },
                { text: "Tighten Floor Bolts", type: "repair", result: "fail", msg: "You tighten them, but the shaking comes from inside. It trips offline. (+5 XP)", xp: 5, damage: 20 },
                { text: "Ignore it", type: "lazy", result: "crit_fail", msg: "BOOM. The compressor destroys itself.", xp: 0, damage: 45 }
            ]
        },

        // ZONE: CMMS TOWER (5 Scenarios)
        {
            zone: 'cmms',
            title: "The Ghost in the Machine",
            text: "The work order history for the Crusher has vanished. Without history, the predictive model is blind.",
            reflection: "FACT: Garbage in, garbage out.",
            choices: [
                { text: "Cast 'Data Audit' (Analyze Logs)", type: "analyze", result: "success", msg: "You trace the deletion to a glitch and find a Backup Disk! (+20 XP)", xp: 20, damage: 0, reward: "backupDisk" },
                { text: "Guess the Failure Mode", type: "strategy", result: "fail", msg: "You guess wrong. The model learns the wrong lesson.", xp: 5, damage: 15 },
                { text: "Reboot the Server", type: "repair", result: "neutral", msg: "You turn it off and on again. It works, but root cause unknown.", xp: 10, damage: 5 }
            ]
        },
        {
            zone: 'cmms',
            title: "The Scrolls of Root Cause",
            text: "Three identical pumps have failed this month. The ancient scrolls whisper of a pattern.",
            reflection: "WISDOM: Look for patterns across failures.",
            choices: [
                { text: "Use Backup Disk to Compare", type: "analyze", result: "success", msg: "Using the backup data, you find the exact correlation. Masterful! (+30 XP)", xp: 30, damage: 0, requires: "backupDisk" },
                { text: "Consult the Data Oracle", type: "analyze", result: "success", msg: "The pattern reveals itself: peak load failures. (+20 XP)", xp: 20, damage: 0 },
                { text: "Replace All Three Pumps", type: "repair", result: "neutral", msg: "Expensive fix. You found a Scroll of RCA in the box though. (+10 XP)", xp: 10, damage: 5, reward: "rcaScroll" },
                { text: "Blame the Operator", type: "lazy", result: "fail", msg: "The operators revolt. Production halts.", xp: 0, damage: 25 }
            ]
        },
        {
            zone: 'cmms',
            title: "The Phantom of PM Compliance",
            text: "The maintenance schedule shows gaps. Critical assets haven't been touched in months.",
            reflection: "TRUTH: Compliance tracking is essential.",
            choices: [
                { text: "Summon the Schedule Keeper", type: "plan", result: "success", msg: "You identify the gaps and restore the schedule. (+22 XP)", xp: 22, damage: 0 },
                { text: "Perform Emergency PMs Now", type: "repair", result: "neutral", msg: "You catch up, but it's reactive. (+12 XP)", xp: 12, damage: 8 },
                { text: "Ignore the Schedule", type: "lazy", result: "crit_fail", msg: "The phantom grows stronger. Unplanned failures multiply. (-5 XP)", xp: -5, damage: 35 }
            ]
        },
        {
            zone: 'cmms',
            title: "The Oracle of OEE",
            text: "Overall Equipment Effectiveness drops. The Oracle of OEE demands answers.",
            reflection: "METRICS: OEE = Availability √ó Performance √ó Quality.",
            choices: [
                { text: "Consult All Three Pillars", type: "analyze", result: "success", msg: "You identify bottlenecks in all areas. (+32 XP)", xp: 32, damage: 0 },
                { text: "Focus on Availability Only", type: "repair", result: "neutral", msg: "Uptime improves, but quality suffers. (+17 XP)", xp: 17, damage: 10 },
                { text: "Blame the Equipment", type: "lazy", result: "fail", msg: "The oracle scoffs. OEE continues to decline. (+4 XP)", xp: 4, damage: 22 }
            ]
        },
        {
            zone: 'cmms',
            title: "The Data Silo",
            text: "The Operations Tribe and Maintenance Guild are using different data scrolls. Confusion reigns.",
            reflection: "CULTURE: One source of truth is essential for decision making.",
            choices: [
                { text: "Integrate Systems", type: "strategy", result: "success", msg: "You build a bridge between the databases. Harmony is restored. (+28 XP)", xp: 28, damage: 0 },
                { text: "Hold a Meeting", type: "plan", result: "neutral", msg: "People yell for an hour. Nothing changes. (+5 XP)", xp: 5, damage: 5 },
                { text: "Pick Sides", type: "lazy", result: "fail", msg: "The war escalates. Data is lost in the crossfire. (+0 XP)", xp: 0, damage: 15 }
            ]
        },

        // ZONE: DUNGEON (5 Scenarios)
        {
            zone: 'dungeon',
            title: "The Dungeon of Spare Parts",
            text: "A critical pump has failed. You rush to the store room, but the shelves are in chaos.",
            reflection: "DID YOU KNOW? Clean data saves time!",
            choices: [
                { text: "Cast 'Inventory Lookup' (Check BOM)", type: "plan", result: "success", msg: "The BOM is accurate! You find a Spare Seal in Bin 4B. (+20 XP)", xp: 20, damage: 0, reward: "spareSeal" },
                { text: "Rummage Blindly", type: "repair", result: "fail", msg: "You spend 3 hours digging. Wrong size found.", xp: 5, damage: 20 },
                { text: "Cannibalize Old Pump", type: "repair", result: "neutral", msg: "Risky... but it fits for now.", xp: 10, damage: 5 }
            ]
        },
        {
            zone: 'dungeon',
            title: "The Leak of DOOM",
            text: "A high pressure pipe has sprung a leak! The fluid is everywhere.",
            reflection: "SAFETY: Containment first.",
            choices: [
                { text: "Install Spare Seal", type: "repair", result: "success", msg: "You quickly swap in the Spare Seal you found earlier. Perfect fit! (+30 XP)", xp: 30, damage: 0, requires: "spareSeal" },
                { text: "Apply Emergency Tape", type: "repair", result: "neutral", msg: "It holds... barely. (+10 XP)", xp: 10, damage: 10 },
                { text: "Let it Leak", type: "lazy", result: "crit_fail", msg: "Environmental disaster! The EPA has been summoned.", xp: 0, damage: 50 }
            ]
        },
        {
            zone: 'dungeon',
            title: "The Curse of the Backlog",
            text: "The backlog grows like a shadow. 200 work orders await.",
            reflection: "REALITY: Prioritization matters.",
            choices: [
                { text: "Cast Prioritization Spell", type: "strategy", result: "success", msg: "You focus on critical assets first. (+28 XP)", xp: 28, damage: 0 },
                { text: "Work Faster", type: "repair", result: "neutral", msg: "You clear 50 orders, but burnout sets in. (+15 XP)", xp: 15, damage: 12 },
                { text: "Close Old Work Orders", type: "lazy", result: "fail", msg: "Hidden failures emerge. (+3 XP)", xp: 3, damage: 20 }
            ]
        },
        {
            zone: 'dungeon',
            title: "The Labyrinth of Legacy Systems",
            text: "Ancient equipment runs on obsolete protocols. Modernization is required.",
            reflection: "CHALLENGE: Migration planning is critical.",
            choices: [
                { text: "Chart Migration Path", type: "strategy", result: "success", msg: "You create a phased migration. (+27 XP)", xp: 27, damage: 0 },
                { text: "Patch and Maintain", type: "repair", result: "neutral", msg: "It works for now, but technical debt accumulates. (+13 XP)", xp: 13, damage: 9 },
                { text: "Ignore Until Failure", type: "lazy", result: "crit_fail", msg: "When it fails, no one knows how to fix it. (+0 XP)", xp: 0, damage: 40 }
            ]
        },
        {
            zone: 'dungeon',
            title: "The Vendor's Ransom",
            text: "The manufacturer says the replacement part has a 52-week lead time.",
            reflection: "SUPPLY CHAIN: Strategic spares must be identified before failure.",
            choices: [
                { text: "Reverse Engineer Part", type: "repair", result: "success", msg: "You create a 3D printed temporary part and order a custom fabrication. (+30 XP)", xp: 30, damage: 0 },
                { text: "Pay Expedite Fee", type: "plan", result: "neutral", msg: "It costs 10x the price, but arrives in 4 weeks. Downtime hurts. (+10 XP)", xp: 10, damage: 20 },
                { text: "Wait", type: "lazy", result: "crit_fail", msg: "The plant shuts down for a year. You are fired. (+0 XP)", xp: 0, damage: 100 }
            ]
        }
    ];

    const FINAL_SCENARIO = {
        title: "The Final Stand: The Demon of Downtime",
        text: "The Demon of Downtime rises. All your skills are tested.",
        reflection: "LEGEND: Master all paths.",
        choices: [
            { text: "Unite All Disciplines (Holistic Approach)", type: "strategy", result: "success", msg: "You combine CBM, planning, and data. The demon falls! (+50 XP)", xp: 50, damage: 0 },
            { text: "Cast 'Ultimate RCA'", type: "analyze", result: "success", msg: "Using your Scroll of RCA, you banish the root cause forever! (+60 XP)", xp: 60, damage: 0, requires: "rcaScroll" },
            { text: "Rush to Repair", type: "repair", result: "neutral", msg: "You fight valiantly, but the demon returns. (+20 XP)", xp: 20, damage: 15 },
            { text: "Panic and React", type: "lazy", result: "crit_fail", msg: "The demon laughs. Darkness falls. (+0 XP)", xp: 0, damage: 50 }
        ]
    };

    /* --- LOGIC --- */
    let state = {
        hero: null,
        hp: 100,
        xp: 0,
        inventory: [],
        completedZones: [],
        activeScenarios: [], 
        currentScenarioIndex: 0
    };

    const ui = {
        screens: document.querySelectorAll('.screen'),
        classList: document.getElementById('class-list'),
        mapGrid: document.getElementById('map-grid'),
        storyArea: document.getElementById('story-area'),
        controls: document.getElementById('controls-area'),
        hpBar: document.getElementById('hp-bar'),
        xpDisplay: document.getElementById('xp-display'),
        invDisplay: document.getElementById('inventory-display'),
        diceOverlay: document.getElementById('dice-overlay'),
        d20: document.getElementById('d20-die'),
        rollText: document.getElementById('roll-text')
    };

    function init() { renderClasses(); }
    function showScreen(id) { ui.screens.forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    function updateInventoryDisplay() {
        if (state.inventory.length === 0) {
            ui.invDisplay.innerText = 'Empty';
        } else {
            ui.invDisplay.innerHTML = state.inventory.map(item => `<span class="inv-item" title="${TOOLS[item].name}">${TOOLS[item].icon}</span>`).join(' ');
        }
    }

    /* CLASS SELECTION */
    function renderClasses() {
        ui.classList.innerHTML = '';
        CLASSES.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.onmouseenter = () => playSound('hover');
            card.onclick = () => selectClass(cls);
            
            const imgHTML = `<div class="card-image-slot">
                <img src="${cls.img}" 
                     onerror="if (!this.getAttribute('data-retried')) { 
                        this.setAttribute('data-retried', 'true');
                        if(this.src.endsWith('.png')) this.src = this.src.replace('.png', '.jpg');
                        else if(this.src.endsWith('.jpg')) this.src = this.src.replace('.jpg', '.png');
                     } else { 
                        this.parentElement.classList.add('missing-img'); 
                     }">
            </div>`;

            card.innerHTML = `
                ${imgHTML}
                <div class="class-name">${cls.name}</div>
                <div class="class-role">${cls.role}</div>
                <div style="margin-top:5px; font-size:0.8rem; color:#6e5a3e;">Strong vs: ${cls.bonus.toUpperCase()}</div>
            `;
            ui.classList.appendChild(card);
        });
    }

    function selectClass(cls) {
        playSound('click');
        state.hero = cls;
        state.hp = 100;
        state.xp = 0;
        state.inventory = [];
        state.completedZones = [];
        document.getElementById('hero-name').innerText = cls.name;
        updateStats();
        updateInventoryDisplay();
        renderMap();
        showScreen('map-screen');
    }

    /* MAP LOGIC */
    function renderMap() {
        ui.mapGrid.innerHTML = '';
        
        ZONES.forEach(zone => {
            const isCompleted = state.completedZones.includes(zone.id);
            const zoneEl = document.createElement('div');
            zoneEl.className = `map-zone ${isCompleted ? 'completed' : ''}`;
            zoneEl.style.backgroundImage = `url('${zone.img}')`;
            
            const imgCheck = new Image();
            imgCheck.src = zone.img;
            imgCheck.onerror = () => {
                zoneEl.classList.add('missing-zone-img');
                zoneEl.style.backgroundImage = 'none';
            };

            zoneEl.innerHTML = `<div class="icon">${zone.icon}</div><div class="map-zone-content"><h3>${zone.name}</h3></div>`;
            
            if (!isCompleted) {
                zoneEl.onclick = () => enterZone(zone.id);
                zoneEl.onmouseenter = () => playSound('hover');
            }
            ui.mapGrid.appendChild(zoneEl);
        });

        if (state.completedZones.length === ZONES.length) {
            const bossEl = document.createElement('div');
            bossEl.className = 'map-zone';
            bossEl.style.borderColor = 'var(--blood-red)';
            bossEl.style.backgroundImage = "url('img/demon.png')";
            
            const imgCheck = new Image();
            imgCheck.src = 'img/demon.png';
            imgCheck.onerror = () => {
                bossEl.classList.add('missing-zone-img');
                bossEl.style.backgroundImage = 'none';
                bossEl.style.backgroundColor = '#2b0000';
            };

            bossEl.innerHTML = `<div class="icon" style="font-size:4rem;">üëπ</div><div class="map-zone-content"><h3>The Demon's Lair</h3></div>`;
            bossEl.onclick = () => enterBossFight();
            bossEl.onmouseenter = () => playSound('hover');
            ui.mapGrid.appendChild(bossEl);
        }
    }

    function enterZone(zoneId) {
        playSound('click');
        
        // REPLAYABILITY LOGIC: Shuffle and pick 2
        const pool = SCENARIO_DB.filter(s => s.zone === zoneId);
        state.activeScenarios = shuffleArray(pool).slice(0, 2); // Random 2 scenarios per zone
        
        state.currentScenarioIndex = 0;
        state.currentZoneId = zoneId;
        loadScenario();
        showScreen('game-screen');
    }

    function shuffleArray(array) {
        // Fisher-Yates Shuffle for true randomness
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function enterBossFight() {
        playSound('click');
        state.activeScenarios = [FINAL_SCENARIO];
        state.currentScenarioIndex = 0;
        state.currentZoneId = 'boss';
        loadScenario();
        showScreen('game-screen');
    }

    function updateStats() {
        ui.hpBar.style.width = Math.max(0, state.hp) + "%";
        ui.xpDisplay.innerText = state.xp;
    }

    /* SCENARIO RUNNER */
    function loadScenario() {
        const scen = state.activeScenarios[state.currentScenarioIndex];

        ui.storyArea.innerHTML = `
            <h2 style="color:var(--accent-gold)">${scen.title}</h2>
            <div class="journal-entry">${scen.text}</div>
            <div id="result-log"></div>
            <div id="reflection-panel" class="reflection-box">
                <strong>üí° DM's NOTE:</strong><br>
                ${scen.reflection}
                <br><br>
                <button class="btn-retro" style="width:100%" onclick="nextStep()">Continue Journey >></button>
            </div>
        `;

        ui.controls.innerHTML = '';
        ui.controls.style.display = 'block'; 

        scen.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'btn-retro';
            btn.style.width = '100%';
            
            let bonusText = "";
            if (choice.type === state.hero.bonus) {
                bonusText = " <span style='color:var(--magic-cyan)'>(Class Bonus)</span>";
                btn.style.borderColor = "var(--magic-cyan)";
            }

            // Tool Requirement Check
            if (choice.requires && !state.inventory.includes(choice.requires)) {
                btn.disabled = true;
                btn.innerHTML = `üîí ${choice.text} <span style="font-size:0.8em; color:#888">(Requires ${TOOLS[choice.requires].name})</span>`;
            } else {
                btn.innerHTML = `üëâ ${choice.text} ${bonusText}`;
                btn.onclick = () => initiateRoll(choice); // START ROLL
                btn.onmouseenter = () => playSound('hover');
            }

            ui.controls.appendChild(btn);
        });
    }

    /* --- DICE ANIMATION LOGIC --- */
    function initiateRoll(choice) {
        playSound('click');
        ui.controls.style.display = 'none';
        
        // Show Overlay
        ui.diceOverlay.style.display = 'flex';
        ui.d20.classList.add('shake');
        ui.d20.className = 'd20-die shake'; // Reset style
        ui.rollText.innerText = "Rolling...";
        playSound('rolling');

        let counter = 0;
        let rollInterval = setInterval(() => {
            ui.d20.innerText = Math.floor(Math.random() * 20) + 1;
            counter++;
            if (counter > 10) {
                clearInterval(rollInterval);
                finishRoll(choice);
            }
        }, 100);
    }

    function finishRoll(choice) {
        ui.d20.classList.remove('shake');
        let finalRoll = 0;

        // Determine "Visual" Roll based on outcome type
        if (choice.result === 'success') {
            finalRoll = 12 + Math.floor(Math.random() * 8); // 12-19
            if(Math.random() > 0.8) finalRoll = 20; // 20% chance of Crit visually
            ui.d20.classList.add('roll-result-success');
            if(finalRoll === 20) ui.d20.classList.add('roll-result-crit');
        } else if (choice.result === 'neutral') {
            finalRoll = 8 + Math.floor(Math.random() * 4); // 8-11
            ui.d20.classList.add('roll-result-fail');
        } else if (choice.result === 'fail') {
            finalRoll = 2 + Math.floor(Math.random() * 6); // 2-7
            ui.d20.classList.add('roll-result-fail');
        } else { // Crit Fail
            finalRoll = 1;
            ui.d20.classList.add('roll-result-critfail');
        }

        ui.d20.innerText = finalRoll;
        ui.rollText.innerText = finalRoll >= 12 ? "SUCCESS!" : "FAILURE...";
        
        if (finalRoll >= 12) playSound('success'); else playSound('fail');

        setTimeout(() => {
            ui.diceOverlay.style.display = 'none';
            resolveTurn(choice, finalRoll);
        }, 1500);
    }

    function resolveTurn(choice, rollValue) {
        state.xp += choice.xp;
        state.hp -= choice.damage;
        
        // Handle Inventory Reward
        if (choice.reward && !state.inventory.includes(choice.reward)) {
            state.inventory.push(choice.reward);
            updateInventoryDisplay();
            playSound('loot');
        }

        updateStats();

        const log = document.getElementById('result-log');
        let color = choice.damage > 0 ? 'var(--blood-red)' : 'var(--magic-cyan)';
        
        let rollMsg = `<span style="color:#888; font-size:0.8em">[Rolled: ${rollValue}]</span> `;
        let rewardMsg = choice.reward ? `<br><br><span style="color:gold">‚ú® ACQUIRED: ${TOOLS[choice.reward].name}</span>` : '';

        log.innerHTML = `<p style="color:${color}; font-weight:bold; margin-top:1rem;">${rollMsg} > ${choice.msg}${rewardMsg}</p>`;

        document.getElementById('reflection-panel').style.display = 'block';
    }

    function nextStep() {
        playSound('click');
        if (state.hp <= 0) {
            endGame();
            return;
        }

        state.currentScenarioIndex++;

        if (state.currentScenarioIndex < state.activeScenarios.length) {
            loadScenario(); 
        } else {
            if (state.currentZoneId === 'boss') {
                endGame();
            } else {
                if (!state.completedZones.includes(state.currentZoneId)) {
                    state.completedZones.push(state.currentZoneId);
                }
                renderMap();
                showScreen('map-screen');
            }
        }
    }

    function endGame() {
        showScreen('end-screen');
        document.getElementById('final-score').innerText = state.xp;
        
        const title = document.getElementById('end-title');
        const desc = document.getElementById('end-desc');

        if (state.hp <= 0) {
            title.innerText = "Production Halted";
            title.style.color = "var(--blood-red)";
            desc.innerText = "The facility has fallen silent. The demons of downtime have won.";
            playSound('fail');
        } else {
            if (state.xp >= 250) {
                title.innerText = "Reliability Legend";
                title.style.color = "var(--magic-cyan)";
                desc.innerText = "The assets hum with efficiency. You have mastered all disciplines.";
                playSound('success');
            } else if (state.xp >= 150) {
                title.innerText = "Guardian of Uptime";
                title.style.color = "var(--accent-gold)";
                desc.innerText = "The plant is running well. Good work.";
                playSound('success');
            } else {
                title.innerText = "Reactive Firefighter";
                title.style.color = "#a89f81"; 
                desc.innerText = "You survived... barely. The assets are limping along.";
                playSound('fail'); 
            }
        }
    }

    init();
    document.body.addEventListener('click', function() {
        if(audioCtx.state === 'suspended') { audioCtx.resume(); }
    }, {once:true});

</script>
</body>
</html>